\section{Sentilo}

Sentilo is an open source platform to store sensor and actuators information.
This platform is designed for the smart cities environment,
	to be used as a sensor data server that stores the data from different providers and different components within the providers.

\subsection{Definitions}

\textbf{Provider:} A Sentilo account in the server. It stores the published data, and
sends the data to his subscribers.

\textbf{Publisher:} A device that sends data to the server. It publish the data into a
provider account.

\textbf{Subscriber:} A device that receives data. It is subscribed to a certain data from a
provider

\textbf{Worker:} A threat in the server that executes a programed task

\textbf{Redis:} A in-memory data structure store. It is used as a Publisher/Subscriber
implementation to store the data in the memory of the server.

\textbf{MongoDB:} A database that stores the data as 'documents'. A 'document' is a
JSON object.


\subsection{Sentilo Architecture}

The platform has 3 distinct parts:

PubSub Server (Core)

Web Catalog Application (A web interface to check the information of the
PubSub Server)

Extensions (Also called Agents, they extend the capabilities of the PubSub
Server)

The core platform, listens and responds to requests specified in the API. By default,
it listens the TCP port 8081

- For a publisher, it registers the data sent, in one of the platform items.

- For subscribers, it responds with a JSON with the requested data of an item.

The web catalog, is a web interface to manage and see the information on the
PubSub Server. It listens the TCP port 8080.
The platform supports some extensions in order to extend the base functionalities
such as alerts or data storage.

\subsubsection{PubSub Server}

The Core of the platform is a running process,
	that listens to the requests and creates workers (Threads) to do the tasks.
There are 2 requesters:

Publishers:
	Send data from sensors,
	and alerts.

Subscribers:
	First,
	they request a subscription.
Then waits for the data they are subscribed is sent.
The platform is separated in 2 different layers:
	Transport and Service.
The transport layer manages the incoming requests (as published data,
	data requests or subscription requests) and generates a queue with tasks containing the information of the request.
Then,
	a limited pool of workers handles the requests,
	every time each finishes the previous task.

When a client sends an Http request to the platform,
	the process is:
	(Fig. 76).
1.The server accepts the request.
2.Queues the request on the list of pending requests.
3.When a Worker is available,
	a pending task is assigned to it for processing(removing it from the queue) (a) delegates the request to an element of the service layer (b) constructs the HTTP response from the information received.
4.Sends the response to the client's request 

The service layer manages the workers information and processes it and registers the data or delivers the data depending on the request. (Fig. 77) 

1.The Worker delegates the request to the associated handler depending on the type of request (data,
	order,
	alarm,
	...)

2.The following validations are performed on each request:
	(a) Integrity of credential:
	checks the received token sent in the header using the internal database in memory containing all active credentials in the system.
(b) Authorization to carry out the request:
	validate that the requested action can be done according to the permission database.

3.Stores the data in Redis (in memory),
	and depending on the type of data (a) Publish the data through publish mechanism (b) Register of the subscription in the ListenerMessageContainer (A list of all subscribers) and into Redis as a subscriber.

4. If any new data is received,
	Redis publish the data to the subscribers,
	otherwise this step is skipped.

5. The container notifies the event to each subscriber associated with it by sending an HTTP Request to them.


\subsubsection{Web Catalog Application}

The catalog application platform is a web application that uses MongoDB as data
storage database.
The Web App has 2 parts:

- A public console for displaying public data of components and sensors and
their data

- A secured part for resources administration: providers, client apps, sensors,
components, alerts, permissions, ...

It is fully integrated with the Publish/Subscribe platform for data synchronization:

- Permission and authentication data

- Register statistical data and the latest data received for showing it in different
graphs of the Web application.

\subsubsection{Extensions (Agents)}

The extensions of Sentilo add functionalities to the Core application.
The extensions are subscribed to the Redis module for all the incoming notifications.

When Redis receives a publication of data, sends a message to all subscribers,
including all the agents.
The agent gets the data, and carries out his task.
Currently there are 3 Sentilo agents:

- Relational database agent

- Stores all the incoming data in a external database
Alarm agent

- Manages the internal alerts defined into the Web Catalog and published an
alert if the condition is met.

- Location updater agent

Is responsible of updating automatically the component location according
to the location of the published observations.

\subsection{Sentilo structure}

The platform has 5 main items:
- Component
- Sensor
- Alert
- Alarm
- Order
A component is the item where a set of sensors is attached.
A sensor is a representation of a physical sensor,
	it is attached to a component.
The data published is sent for a specific sensor.
An alert is a trigger registered in Sentilo when an event happens.
There a 2 types of alerts:
	internal and external.
The internal alerts are related to specific sensors and it's logic is defined using basic math rules or configuring an inactivity time.
The external alerts are defined by third party entities,
	which will be the responsible of calculating their logic and throw the related alarms when applies.
An alarm is the message sent to the subscribers of an alert when it is triggered.
Must be attached to an alert.
An order is a message registered for a specific sensor or component.
It is received by the subscribers of the sensor or component orders.

\subsection{Sentilo API}

The Application Programming Interface (API) define a set of commands, functions
and protocols that must be followed by who wants to interact with the platform from
external systems, like sensors/actuators or applications.
The requests are HTTP requests with 3 fields in the header:

- The Request Method: GET, POST, PUT

- IDENTITYKEY: The authentication token

- Content-Type: application/json

The platform has 3 operations for publishers:

-Retrieve data: Using the GET method, any kind of data can be consulted, the
response is in JSON format

-Register data: Using the POST method, can be registered components, sensors
alerts, alarms or orders.

-Update data: Using the PUT method, components, sensors alerts, alarms and
orders data can be updated. Also sensor data can be published.
It also has 3 kind of subscriptions:

- To sensor data
- To orders
- To alerts

All the documentation of the Application Programming Interface can be found in:

- http://www.sentilo.io/xwiki/bin/view/APIDocs/WebHome




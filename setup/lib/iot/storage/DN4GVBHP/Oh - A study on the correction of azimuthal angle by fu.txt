A study on the correction of azimuthal angle by fusion of geomagnetic sensor and inertial sensor

Jongtaek Oh Department of Electronics & Information
Hansung University Seoul, South Korea jtoh@hansung.ac.kr

Abstract— For indoor navigation systems that use low-cost a geomagnetic sensor were used to correct the sensor frame

sensors such as those built-in to smartphones, azimuth estimation is error in [4]. Also it was proposed a maximum likelihood

critical to location accuracy. However, the accuracy of the measured azimuth in many locations is very bad due to the influence of the magnetic field on the geomagnetic sensor. In this paper, the geomagnetic sensor data are fused with the acceleration sensor and gyro sensor data, to correct the erroneous azimuthal angle and it shows improved performance compared to the conventional method.

estimator for iteratively correcting geomagnetic distortion [5], and a method of using the geomagnetic sensor parameters after first calibrating them in a place without distortion is also proposed in [6]. However, it is difficult to apply to general equipment such as smartphones and accuracy is not appropriate.

Keywords— azimuth, geomagnetic sensor, acceleration sensor, gyro sensor, fitting

In this paper, I apply the acceleration sensor and the gyro sensor to the Extended Kalman Filter (EKF) to estimate the rotation angle of the smartphone, and measure the

I. INTRODUCTION The navigation device tracking the trajectory of the moving object is based on the moving direction and distance. As a method of estimating the moving direction, there is a method of estimating a rotation angle using a gyro sensor, and an azimuthal angle estimation using a geomagnetic sensor. For

geomagnetic sensor value at the same time. By fusion of these two data, the geomagnetic sensor values mx and my with mitigated distortion are estimated. Experiments have been carried out by the proposed method and the improved performance is confirmed as compared with the conventional method.

the gyro sensor, the rotation angle estimation is accurate in a short time, but there is a problem that the error accumulates as the time passes. The acceleration sensor has no cumulative error, but it cannot measure the yaw (  ) angle in the twodimensional plane. Therefore, we can estimate the rotation angle yaw by fusion of these two sensors [1]. In this case, however, there is a problem of not knowing the azimuthal angle at the initial stage of starting, and there is a problem that

II. MASUREMENTS OF GEOMAGNETIC SENSOR In order to fuse rotation angle measured by inertial sensors and azimuthal angle estimated by geomagnetic sensor, the angle of rotation must be precisely estimated using the EKF. The gyro sensor data was applied to the state transition equations and the acceleration sensor data was used as the measurement value.

the rotation angle error becomes cumulative as the moving object moves.

A. Rotation Angle Measurements

On the other hand, in the geomagnetic sensor, the

The equation for approximately calculating the roll angle 

measurement values of the geomagnetic field intensity in the x, y, and z directions of the navigation frame are measured as mx , my , and mz , respectively. The azimuthal angle  is

and pitch angle  of the smartphone using the acceleration
sensor is (1), where g is the gravity, and fx and fy are the acceleration values of x and y axis in the navigation frame,

computed using mx and my , because the azimuthal angle on respectively [1].

the two-dimensional plane is only required for the user walking with the smartphone. However, since there are  scattered iron devices around the user, these devices affect the

s in1  gf x  , 

sin 1

 

f y g  cos

 

(1)

geomagnetic sensor, resulting in distortions in measured mx
and my [2]. As a result, the azimuthal angle using the geomagnetic sensor becomes incorrect in many locations. A variety of studies have been conducted to correct this distortion.
[3] used many true azimuthal angle data and measured data in order to learn the neural network, and an inertial sensor and

The following EKF model equations using gyro sensor
values as state variables x     T are as follows,

x  f (x ,y ,z ,  x )  w  f1 f2 f3 T  w

(2)

where i is the angular velocity measured from gyro sensor, w is system noise,  is the rotation angle, and

978-1-7281-1340-1/19/$31.00 ©2019 IEEE

742

ICUFN 2019

f1  x  y sin  tan   z cos  tan  , f2 y cos   z sin  , f3 y sin  / cos  z cos  / cos .

The discrete time system model equation is as follows and
A is Jacobian of fi . The measurement equation is (4) and v is the measurement noise, where z is the measured  and .

 xk 1 A xk  wk

(3)

z

10 0 010

  

   



v

(4)

B. Conventional Geomagnetic Sensor Correction Method Geomagnetic distortion is classified into hard iron and soft
iron. In the absence of distortion, the geomagnetic field strengths mx and my could be plotted on a two-dimensional plane as a circle centered at the origin. However, in the case of distortion, the central axis moves and becomes a rotated ellipse. In [7], in order to correct the sensor data error due to geomagnetic distortion, the ellipse was rotated in the opposite direction and the shape was adjusted to form a circle. The following figure depicts mx and my with and without distortion.

A. Linear Fitting of Azimuthal Angle Accelerometer sensor and gyro sensor can be used to
measure the angle of rotation comparing geomagnetic sensor data. Therefore, when the azimuthal angle according to geomagnetic sensor data is plotted according to the rotation angle of equidistance, it should become a straight line when there is no distortion. Using this characteristic, the measured azimuthal angle data was fitted to the linear model by Least Mean Square (LMS) method, as below

 ()  a   b

(5)

where  : azimuthal angle,  : rotation angle, a : slope, and b : intercept. (5) is expressed in the form of matrices for the measured azimuthal data as follows for each rotation angle,

1  α(0)-a  0 

1 . 

b



  

α(1)-a 1 .



 

.

(6)

1 α(359)-a  359

(6) can be denoted as AL x  b and, initial azimuthal angle

b

can be obtained as

x





A

T L

A

L

 1

b A T L

by LMS. This

method differs from the conventional method in statistically

correcting the entire geomagnetic sensor data.

Fig. 1. In the left, the solid line is for the case without distortion, and the

dotted line is with distortion. In the right, the solid lines are for mx and the

dotted lines are for m distortion, respectively.

y

without

distortion,

and

the

marked

lines

are

with

Fig. 2. In the left, the solid line is the rotation angle obtained by the inertial sensors on the time axis, and the dotted line is the azimuthal angle calculated by geomagenetic sensor data. The right figure shows the estimated error corresponing to the rotation angle. Solid line is uncorrected, dotted line is by conventional method, and marked line is result by proposed linear fitting method.

III. NOVEL DISTORTION CORRECTION
There would be three methods to correct the geomagnetic sensor value in the graph domain. The first method of the conventional method, is to transform the center-point moving and distorted circle-shaped geomagnetic sensor data into circlelike data with the center point at the origin. In this paper, I propose a novel method of fitting the rotation angle and the azimuthal angle to the linear model and a method of least square fitting the mx and my intensity to the sinusoidal function.

Fig. 3. In the left, the solid line is the rotation angle to which the initial azimuth angle is added, the dotted line is not corrected, the '+' marked line is the conventional method, and the 'o' marked line is the linear fitting result. The right figure shows the estimated error corresponing to the rotation angle.

743

These are for the place where the geomagnetic distortion is more severe than the place of Fig. 2.
As shown in Fig. 2 and 3, linear fitting using LMS shows much more accurate results than the conventional method.

sinusoidal fitting method. Both methods showed much better performance than the conventional method and confirmed that the performance varies depending on the degree of geomagnetic distortion.

B. Sinusoidal Fitting of mx and my
The azimuth angle is calculated with the geomagnetic field intensity mx and my which could be distorted. Thus, it could be fitted to the original form of mx and my without distortion to improve accuracy. The geomagnetic field intensity measured by the geomagnetic sensor could be modeled as follows,

mx  xoffset  kx  sin(  1 )

(7)

my  yoffset  k y  cos(  2 )

where xoffset and yoffset are the distances from the center of the
figure to the origin in the mx - my plane, respectively, kx and
ky are amplitude coefficients, and 1 and 2 are phase shifts in the geomagnetic intensity-angle plane. When the geomagnetic sensor data is circle, 1 and 2 should be the same, and it stands for the azimuthal angle for which the smartphone is aiming. (7) is non-linear equation of  , so the parameters are estimated using least square function of lsqcurvefit() in MATLAB.

Fig. 5. Fitting results in a place with greater distortion than in Fig. 4.

TABLE I.
place method No correction Conventional method Linear fitting Sinusoidal fitting

GEOMAGNETIC SENSOR CORRECTION PERFORMANCE

RMS estimation error of azimuthal angle [degree]

Place A

Place B

Place C

13.3

18.5

42.5

6.5

13.4

29.0

5.8

12.2

12.9

5.1

12.5

28.8

ACKNOWLEDGMENT This work was supported by the 2018 Research Fund of the NRF (No. 2017R 1D 1A 1B03031244).

Fig. 4. In the left, the solid line and the dotted line are measured mx and my , respectively, and the marked lines are fitted results to the sinusoidal functions by the least square method. The right figure shows the estimated azimuthal angle corresponing to the rotation angle.
Fig. 4 is the result of fitting in the same place as Fig. 2. In smaller geomagnetic distortion locations, the sinusoidal fitting works better, but in larger locations the linear fitting performs better.
IV. CONCLUSION The conventional method is to correct the distorted circle on the mx - my plane with a circle geometrically, but in the proposed method, the geomagnetic sensor data sampled according to the rotation angle is corrected by linear or

REFERENCES
[1] Phil Kim, Kalman Filter for Beginners with MATLAB Examples. Seoul, A-JIN Publishing, 2011.
[2] W.H.K. Vries, H.E.J. Veeger, C.T.M. Baten, and F.C.T. Helm, “Magnetic distortion in motion labs, implications for validating inertial magnetic sensors,” Gait & Posture, no. 29, 2009, pp. 535-541.
[3] J.H. Wang and Y. Gao, “A new magnetic compass calibration algorithm using neural networks,” Measurement Scienc and Technology, no. 17, 2006, pp. 153-160.
[4] S. Bonnet, C. Bassompierre, C. Godin, S. Lesecq, and A. Barraud, “Calibration methods for inertial and magnetic sensors,” Sensors and Actuators, no. 156, 2009, pp. 302-311.
[5] J.F. Vasconcelos, G. Elkaim, C. Silvestre, P. Oliveira, and B. Cardeira, “Geometric approach to strapdown magnetometer calibration in sensor frame,” IEEE Trans. Aero. Elec. Sys., vol. 47, no. 2, 2011, pp. 12931306.
[6] J. Li, Q. Zhang, D. Chen, M. Pan, and F. Luo, “Magnetic interferential field compensation in geomagnetic measurement,” Trans. Inst. Meas. Cont., vol. 36, no. 2, 2014, pp. 244-251.
[7] C.C. Foster and G.H. Elkaim, “Extension of a two-step calibration methodology to include nonorthogonal sensor axes,” IEEE Trans. Aero. Elec. Sys., vol. 44, no. 3, 2008, pp. 1070-1078.

744

